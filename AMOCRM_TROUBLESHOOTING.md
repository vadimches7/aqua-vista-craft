# Диагностика проблем с AmoCRM

## Шаг 1: Проверьте переменные окружения в Lovable

В Lovable нужно добавить следующие переменные:

1. Зайдите в **Project Settings → Environment Variables**
2. Добавьте переменные:

```
VITE_AMOCRM_DOMAIN=amocrm.ru
VITE_AMOCRM_API_DOMAIN=api-b.amocrm.ru
VITE_AMOCRM_ACCESS_TOKEN=ваш_долгосрочный_токен
```

**Важно:** 
- Токен должен быть полным (весь длинный токен из .env файла)
- Без пробелов и переносов строк
- После добавления переменных нужно перезапустить деплой

## Шаг 2: Проверьте консоль браузера

1. Откройте сайт
2. Нажмите F12 (или Cmd+Option+I на Mac)
3. Перейдите на вкладку "Console"
4. Заполните форму и отправьте заявку
5. Посмотрите, какие ошибки появляются

**Что искать:**
- `AmoCRM: Starting lead creation` - должно появиться
- `hasToken: true` - токен должен быть найден
- Ошибки с кодом 401 - неверный токен
- Ошибки с кодом 403 - нет доступа
- Ошибки с кодом 404 - неправильный API домен
- CORS ошибки - проблема с доменом API

## Шаг 3: Проверьте токен

Токен должен быть в формате:
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6...
```

Если токен истёк (срок действия до 2028 года), нужно получить новый.

## Шаг 4: Проверьте API домен

В коде используется `api-b.amocrm.ru`. Если это не ваш домен API, нужно:
1. Проверить в токене поле `api_domain`
2. Обновить переменную `VITE_AMOCRM_API_DOMAIN` в Lovable

## Шаг 5: Альтернативное решение - Webhook

Если API не работает, можно использовать Webhook:

1. В AmoCRM создайте Webhook
2. Скопируйте URL webhook
3. В Lovable добавьте переменную:
   ```
   VITE_AMOCRM_WEBHOOK_URL=ваш_webhook_url
   ```
4. Код автоматически переключится на webhook, если он настроен

## Частые проблемы:

### Проблема: "AmoCRM токен не настроен"
**Решение:** Проверьте, что переменная `VITE_AMOCRM_ACCESS_TOKEN` добавлена в Lovable

### Проблема: "401 Unauthorized"
**Решение:** Токен неверный или истёк. Получите новый токен в AmoCRM

### Проблема: "CORS error"
**Решение:** Проблема с доменом API. Проверьте `VITE_AMOCRM_API_DOMAIN`

### Проблема: Заявки не создаются, но ошибок нет
**Решение:** Проверьте консоль браузера - там будут детальные логи

## Резервный вариант

Если AmoCRM не работает, заявка автоматически отправится в WhatsApp как резервный вариант.

